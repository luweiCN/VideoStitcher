name: Release

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'ç‰ˆæœ¬æ›´æ–°ç±»åž‹'
        required: true
        type: choice
        options:
          - patch  # 0.1.0 -> 0.1.1 (bug fixes)
          - minor  # 0.1.0 -> 0.2.0 (new features)
          - major  # 0.1.0 -> 1.0.0 (breaking changes)
      pre_release:
        description: 'æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬'
        required: false
        type: boolean
        default: false
      create_tag:
        description: 'åˆ›å»º Git Tag'
        required: false
        type: boolean
        default: true

permissions:
  contents: write

jobs:
  release:
    name: Build and Release
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Get current version
        id: version
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"

      - name: Calculate new version
        id: new_version
        run: |
          VERSION_TYPE="${{ inputs.version_type }}"
          CURRENT_VERSION="${{ steps.version.outputs.current }}"

          # Parse version and increment
          IFS='.' read -ra PARTS <<< "$CURRENT_VERSION"
          MAJOR=${PARTS[0]}
          MINOR=${PARTS[1]}
          PATCH=${PARTS[2]}

          case "$VERSION_TYPE" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"

      - name: Update package.json version
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.version }}"
          npm version $NEW_VERSION --no-git-tag-version

      - name: Build macOS
        run: |
          npm run build:preload
          npm run build:renderer
          npm run make

      - name: Generate release notes
        id: release_notes
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.version }}"
          PRE_RELEASE="${{ inputs.pre_release }}"

          # Get commits since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            COMMITS="Initial release"
          else
            COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" || echo "No commits")
          fi

          NOTES="## ðŸ“¦ Release ${NEW_VERSION}

          **Version Type:** ${{ inputs.version_type }}
          **Date:** $(date +'%Y-%m-%d')

          ### ðŸ“ Changes
          ${COMMITS}

          ### ðŸ“¥ Downloads
          - **macOS DMG:** Recommended for installation
          - **macOS ZIP:** Portable, no installation required
          "

          # Write notes to file for multiline output
          echo "$NOTES" > /tmp/release_notes.txt

          # Also create a JSON version for safe multiline handling
          NOTES_JSON=$(echo "$NOTES" | jq -Rs .)
          echo "notes=${NOTES_JSON}" >> $GITHUB_OUTPUT

      - name: Create Git Tag
        if: inputs.create_tag == true
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add package.json package-lock.json
          git commit -m "chore: bump version to ${NEW_VERSION}"
          git tag -a "v${NEW_VERSION}" -m "Release v${NEW_VERSION}"
          git push origin "v${NEW_VERSION}"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.new_version.outputs.version }}
          name: Release v${{ steps.new_version.outputs.version }}
          body: ${{ fromJSON(steps.release_notes.outputs.notes) }}
          draft: false
          prerelease: ${{ inputs.pre_release }}
          files: |
            out/make/*.dmg
            out/make/zip/darwin/arm64/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-files
          path: |
            out/make/*.dmg
            out/make/zip/darwin/arm64/*.zip
          retention-days: 30

      - name: Release Summary
        run: |
          echo "### âœ… Release Created!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v${{ steps.new_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Type:** ${{ inputs.version_type }}" >> $GITHUB_STEP_SUMMARY
          echo "**Pre-release:** ${{ inputs.pre_release }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ [Download Release](https://github.com/${{ github.repository }}/releases/tag/v${{ steps.new_version.outputs.version }})" >> $GITHUB_STEP_SUMMARY
