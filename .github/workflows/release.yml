name: Release

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'ç‰ˆæœ¬æ›´æ–°ç±»åž‹'
        required: true
        type: choice
        options:
          - patch  # 0.1.0 -> 0.1.1 (bug fixes)
          - minor  # 0.1.0 -> 0.2.0 (new features)
          - major  # 0.1.0 -> 1.0.0 (breaking changes)
      pre_release:
        description: 'æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  # Version bump job - runs once
  version:
    name: Update Version
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.new_version.outputs.version }}
      release_notes: ${{ steps.release_notes.outputs.notes }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Get current version
        id: version
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"

      - name: Calculate new version
        id: new_version
        run: |
          VERSION_TYPE="${{ inputs.version_type }}"
          CURRENT_VERSION="${{ steps.version.outputs.current }}"

          # Parse version and increment
          IFS='.' read -ra PARTS <<< "$CURRENT_VERSION"
          MAJOR=${PARTS[0]}
          MINOR=${PARTS[1]}
          PATCH=${PARTS[2]}

          case "$VERSION_TYPE" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"

      - name: Update package.json version
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.version }}"
          npm version $NEW_VERSION --no-git-tag-version

      - name: Commit and push version change
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add package.json package-lock.json
          git commit -m "chore: bump version to ${NEW_VERSION}"
          git push

      - name: Create Git Tag
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.version }}"
          git tag -a "v${NEW_VERSION}" -m "Release v${NEW_VERSION}"
          git push origin "v${NEW_VERSION}"

      - name: Generate release notes
        id: release_notes
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.version }}"

          # Get commits since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            COMMITS="Initial release"
          else
            COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" || echo "No commits")
          fi

          NOTES="## ðŸ“¦ Release ${NEW_VERSION}

          **Version Type:** ${{ inputs.version_type }}
          **Date:** $(date +'%Y-%m-%d')

          ### ðŸ“ Changes
          ${COMMITS}

          ### ðŸ“¥ Downloads

          #### macOS
          - **DMG:** Recommended for installation (.dmg)
          - **ZIP:** Portable, no installation required

          #### Windows
          - **ZIP:** Portable, no installation required (.zip)
          - **Installer:** Squirrel installer for auto-update support (.nupkg)
          "

          # Create JSON version for safe multiline handling
          NOTES_JSON=$(echo "$NOTES" | jq -Rs .)
          echo "notes=${NOTES_JSON}" >> $GITHUB_OUTPUT

      - name: Upload version info
        uses: actions/upload-artifact@v4
        with:
          name: version-info
          path: |
            package.json
            package-lock.json

  # Build macOS
  build-macos:
    name: Build macOS
    needs: version
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Download version info
        uses: actions/download-artifact@v4
        with:
          name: version-info

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit
        continue-on-error: true

      - name: Retry install dependencies
        if: failure()
        run: npm ci
        timeout-minutes: 15

      - name: Build macOS
        run: |
          npm run build:preload
          npm run build:renderer
          npm run make

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: |
            out/make/**/*.dmg
            out/make/**/*.zip
          if-no-files-found: error

  # Build Windows
  build-windows:
    name: Build Windows
    needs: version
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Download version info
        uses: actions/download-artifact@v4
        with:
          name: version-info

      - name: Install dependencies
        run: npm ci

      - name: Build Windows
        run: |
          npm run build:preload
          npm run build:renderer
          npm run make

      - name: List output directory
        shell: pwsh
        run: |
          echo "=== out directory ==="
          Get-ChildItem -Recurse out | Select-Object FullName
        continue-on-error: true

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: out/make/
          if-no-files-found: error

  # Create release (needs all builds)
  release:
    name: Create Release
    needs: [version, build-macos, build-windows]
    runs-on: ubuntu-latest

    steps:
      - name: Download macOS build
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: macos-build
          path: macos

      - name: Download Windows build
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: windows-build
          path: windows

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.version.outputs.new_version }}
          name: Release v${{ needs.version.outputs.new_version }}
          body: ${{ fromJSON(needs.version.outputs.release_notes) }}
          draft: false
          prerelease: ${{ inputs.pre_release }}
          files: macos/**/*,windows/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          echo "### âœ… Release Created!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v${{ needs.version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Type:** ${{ inputs.version_type }}" >> $GITHUB_STEP_SUMMARY
          echo "**Pre-release:** ${{ inputs.pre_release }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### ðŸ“¦ Build Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- macOS: DMG + ZIP" >> $GITHUB_STEP_SUMMARY
          echo "- Windows: ZIP + Squirrel installer" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¥ [Download Release](https://github.com/${{ github.repository }}/releases/tag/v${{ needs.version.outputs.new_version }})" >> $GITHUB_STEP_SUMMARY
