name: å‘å¸ƒç‰ˆæœ¬

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'ç‰ˆæœ¬æ›´æ–°ç±»å‹'
        required: true
        type: choice
        options:
          - patch  # 0.1.0 -> 0.1.1 (ä¿®å¤ bug)
          - minor  # 0.1.0 -> 0.2.0 (æ–°åŠŸèƒ½)
          - major  # 0.1.0 -> 1.0.0 (ç ´åæ€§å˜æ›´)
      pre_release:
        description: 'æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  # ç‰ˆæœ¬å·æ›´æ–°ä»»åŠ¡ - åªè¿è¡Œä¸€æ¬¡
  version:
    name: æ›´æ–°ç‰ˆæœ¬å·
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.new_version.outputs.version }}
      release_notes: ${{ steps.release_notes.outputs.notes }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: è·å–å½“å‰ç‰ˆæœ¬å·
        id: version
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "å½“å‰ç‰ˆæœ¬: $CURRENT_VERSION"

      - name: è®¡ç®—æ–°ç‰ˆæœ¬å·
        id: new_version
        run: |
          VERSION_TYPE="${{ inputs.version_type }}"
          CURRENT_VERSION="${{ steps.version.outputs.current }}"

          # è§£æç‰ˆæœ¬å·å¹¶é€’å¢
          IFS='.' read -ra PARTS <<< "$CURRENT_VERSION"
          MAJOR=${PARTS[0]}
          MINOR=${PARTS[1]}
          PATCH=${PARTS[2]}

          case "$VERSION_TYPE" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "æ–°ç‰ˆæœ¬: $NEW_VERSION"

      - name: æ›´æ–° package.json ç‰ˆæœ¬å·
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.version }}"
          npm version $NEW_VERSION --no-git-tag-version

      - name: æäº¤å¹¶æ¨é€ç‰ˆæœ¬å˜æ›´
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add package.json package-lock.json
          git commit -m "chore: å‡çº§ç‰ˆæœ¬åˆ° ${NEW_VERSION}"
          git push

      - name: åˆ›å»º Git æ ‡ç­¾
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.version }}"
          git tag -a "v${NEW_VERSION}" -m "å‘å¸ƒç‰ˆæœ¬ v${NEW_VERSION}"
          git push origin "v${NEW_VERSION}"

      - name: ç”Ÿæˆæ›´æ–°æ—¥å¿—
        id: release_notes
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.version }}"

          # è·å–è‡ªä¸Šä¸€ä¸ªæ ‡ç­¾ä»¥æ¥çš„æ‰€æœ‰æäº¤
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            COMMITS="åˆå§‹å‘å¸ƒ"
          else
            COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" || echo "æ— æäº¤è®°å½•")
          fi

          NOTES="## ğŸ“¦ å‘å¸ƒç‰ˆæœ¬ ${NEW_VERSION}

          **ç‰ˆæœ¬ç±»å‹:** ${{ inputs.version_type }}
          **å‘å¸ƒæ—¥æœŸ:** $(date +'%Y-%m-%d')

          ### ğŸ“ æ›´æ–°å†…å®¹
          ${COMMITS}

          ### ğŸ“¥ ä¸‹è½½

          #### macOS
          - **DMG:** æ¨èå®‰è£…æ–¹å¼ (.dmg)
          - **ZIP:** å…å®‰è£…ï¼Œç›´æ¥è¿è¡Œ

          #### Windows
          - **ZIP:** å…å®‰è£…ï¼Œç›´æ¥è¿è¡Œ (.zip)
          - **å®‰è£…åŒ…:** æ”¯æŒè‡ªåŠ¨æ›´æ–°çš„ Squirrel å®‰è£…ç¨‹åº (.nupkg)
          "

          # åˆ›å»º JSON æ ¼å¼ä»¥ä¾¿å®‰å…¨å¤„ç†å¤šè¡Œå†…å®¹
          NOTES_JSON=$(echo "$NOTES" | jq -Rs .)
          echo "notes=${NOTES_JSON}" >> $GITHUB_OUTPUT

      - name: ä¸Šä¼ ç‰ˆæœ¬ä¿¡æ¯
        uses: actions/upload-artifact@v4
        with:
          name: version-info
          path: |
            package.json
            package-lock.json

  # æ„å»º macOS
  build-macos:
    name: æ„å»º macOS
    needs: version
    runs-on: macos-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: ä¸‹è½½ç‰ˆæœ¬ä¿¡æ¯
        uses: actions/download-artifact@v4
        with:
          name: version-info

      - name: å®‰è£…ä¾èµ–
        run: |
          npm ci --prefer-offline --no-audit || {
            echo "ç¬¬ä¸€æ¬¡å®‰è£…å¤±è´¥ï¼Œé‡è¯•ä¸­..."
            npm ci
          }
        timeout-minutes: 15

      - name: æ„å»º macOS
        run: |
          npm run build:preload
          npm run build:renderer
          npm run make

      - name: ä¸Šä¼  macOS æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: |
            out/make/*.dmg
            out/make/*darwin*.zip
            out/make/latest-mac.json
          if-no-files-found: error

      - name: ç”Ÿæˆ macOS æ›´æ–°å…ƒæ•°æ®
        run: |
          VERSION=$(node -p "require('./package.json').version")
          # ä½¿ç”¨ ZIP æ–‡ä»¶è€Œä¸æ˜¯ DMGï¼Œå› ä¸º electron-updater åœ¨ macOS ä¸Šåªæ”¯æŒ ZIP æ ¼å¼
          ZIP_FILE=$(find out/make -name "*darwin*.zip" | head -1)
          if [ -z "$ZIP_FILE" ]; then
            echo "æœªæ‰¾åˆ° macOS ZIP æ–‡ä»¶"
            exit 1
          fi
          ZIP_NAME=$(basename "$ZIP_FILE")
          ZIP_SIZE=$(stat -f%z "$ZIP_FILE" 2>/dev/null || stat -c%s "$ZIP_FILE")
          DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          SHA512=$(shasum -a 512 "$ZIP_FILE" | awk '{print $1}')

          # ç”Ÿæˆ YAML æ ¼å¼ï¼ˆelectron-updater éœ€è¦ .yml æ–‡ä»¶ï¼‰
          cat > latest-mac.yml << EOF
version: ${VERSION}
date: "${DATE}"
files:
  - url: https://github.com/luweiCN/VideoStitcher/releases/download/v${VERSION}/${ZIP_NAME}
    sha512: ${SHA512}
    size: ${ZIP_SIZE}
path: ${ZIP_NAME}
sha512: ${SHA512}
releaseNotes: "å‘å¸ƒç‰ˆæœ¬ v${VERSION}"
EOF

          echo "å·²ç”Ÿæˆ latest-mac.yml:"
          cat latest-mac.yml

          # ç§»åŠ¨åˆ°æ„å»ºç›®å½•ä»¥ä¾¿ä¸Šä¼ 
          mv latest-mac.yml out/make/
        continue-on-error: true

      - name: ä¸Šä¼  macOS æ›´æ–°å…ƒæ•°æ®
        uses: actions/upload-artifact@v4
        with:
          name: macos-update-metadata
          path: out/make/latest-mac.yml
        if: hashFiles('out/make/latest-mac.yml') != ''
        continue-on-error: true

  # æ„å»º Windows
  build-windows:
    name: æ„å»º Windows
    needs: version
    runs-on: windows-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: ä¸‹è½½ç‰ˆæœ¬ä¿¡æ¯
        uses: actions/download-artifact@v4
        with:
          name: version-info

      - name: å®‰è£…ä¾èµ–
        run: |
          npm ci --prefer-offline --no-audit || {
            echo "ç¬¬ä¸€æ¬¡å®‰è£…å¤±è´¥ï¼Œé‡è¯•ä¸­..."
            npm ci
          }
        timeout-minutes: 15

      - name: æ¸…ç†æ—§çš„æ„å»ºäº§ç‰©
        shell: pwsh
        run: |
          if (Test-Path "out") {
            Write-Host "æ¸…ç†æ—§çš„æ„å»ºäº§ç‰©..."
            Remove-Item -Recurse -Force "out"
            Write-Host "âœ… å·²æ¸…ç† out ç›®å½•"
          }

      - name: æ„å»º Windows
        shell: pwsh
        run: |
          npm run build:preload
          npm run build:renderer
          npm run make

          # è¯¦ç»†æ£€æŸ¥ Squirrel è¾“å‡º
          Write-Host "=== æ£€æŸ¥ Squirrel æ„å»ºè¾“å‡º ==="
          $SquirrelDir = "out/make/squirrel.windows/x64"
          if (Test-Path $SquirrelDir) {
            Write-Host "Squirrel ç›®å½•å†…å®¹ï¼š"
            Get-ChildItem $SquirrelDir | ForEach-Object {
              Write-Host "  - $($_.Name) ($([math]::Round($_.Length/1MB, 2)) MB)"
            }

            # æ£€æŸ¥æ˜¯å¦æœ‰ setup.exe
            $SetupExe = Get-ChildItem $SquirrelDir -Filter "*.exe" -ErrorAction SilentlyContinue
            if ($SetupExe) {
              Write-Host "âœ… æ‰¾åˆ° Setup.exe: $($SetupExe.Name)"
            } else {
              Write-Host "âŒ æœªæ‰¾åˆ° Setup.exe"
              Write-Host "âŒ Squirrel å¯èƒ½æœªå®Œæˆæ„å»º"
            }
          } else {
            Write-Host "âŒ Squirrel ç›®å½•ä¸å­˜åœ¨"
          }

      - name: ç”Ÿæˆ Windows æ›´æ–°å…ƒæ•°æ® (latest.yml)
        shell: pwsh
        run: |
          $VERSION = "${{ needs.version.outputs.new_version }}"
          $SquirrelDir = "out/make/squirrel.windows/x64"

          # æŸ¥æ‰¾ nupkg æ–‡ä»¶
          $NupkgFile = Get-ChildItem $SquirrelDir -Filter "*-full.nupkg" | Select-Object -First
          if ($NupkgFile) {
            $NupkgName = $NupkgFile.Name
            $NupkgSize = $NupkgFile.Length
            $NupkgHash = (Get-FileHash -Algorithm SHA256 -Path $NupkgFile.FullName).Hash.ToLower()

            # é€è¡Œç”Ÿæˆ YAML å†…å®¹ï¼Œé¿å… YAML è§£æé—®é¢˜
            $YamlLines = @(
              "version: $VERSION",
              "files:",
              "  - url: https://github.com/luweiCN/VideoStitcher/releases/download/v$VERSION/$NupkgName",
              "    sha512: $NupkgHash",
              "    size: $NupkgSize",
              "path: $NupkgName",
              "sha512: $NupkgHash",
              "releaseNotes: Release v$VERSION"
            )
            $YamlLines -join "`n" | Out-File -FilePath "$SquirrelDir/latest.yml" -Encoding UTF8

            Write-Host "âœ… å·²ç”Ÿæˆ latest.yml"
            Get-Content "$SquirrelDir/latest.yml"
          } else {
            Write-Host "âš ï¸ æœªæ‰¾åˆ° full.nupkg æ–‡ä»¶"
          }
        continue-on-error: true

      - name: åˆ—å‡ºè¾“å‡ºç›®å½•
        shell: pwsh
        run: |
          echo "=== out ç›®å½•ç»“æ„ ==="
          Get-ChildItem -Recurse out | Select-Object FullName
        continue-on-error: true

      - name: ä¸Šä¼  Windows æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: |
            out/make/**/RELEASES
            out/make/**/*.zip
            out/make/**/*.nupkg
            out/make/**/*Setup.exe
            out/make/**/latest.yml
          if-no-files-found: error

      - name: éªŒè¯ artifact å†…å®¹
        shell: pwsh
        run: |
          Write-Host "=== éªŒè¯ä¸Šä¼ çš„ artifact ==="
          $ExeFiles = Get-ChildItem -Recurse out/make -File "*Setup.exe" -ErrorAction SilentlyContinue
          Write-Host "æ‰¾åˆ° Setup.exe æ–‡ä»¶: $($ExeFiles.Count) ä¸ª"
          $ExeFiles | ForEach-Object {
            Write-Host "  - $($_.FullName)"
          }

  # åˆ›å»ºå‘å¸ƒï¼ˆéœ€è¦æ‰€æœ‰æ„å»ºå®Œæˆï¼‰
  release:
    name: åˆ›å»ºå‘å¸ƒ
    needs: [version, build-macos, build-windows]
    runs-on: ubuntu-latest

    steps:
      - name: ä¸‹è½½ macOS æ„å»º
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: macos-build
          path: macos

      - name: ä¸‹è½½ macOS æ›´æ–°å…ƒæ•°æ®
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: macos-update-metadata
          path: macos

      - name: ä¸‹è½½ Windows æ„å»º
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: windows-build
          path: windows

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.version.outputs.new_version }}
          name: å‘å¸ƒç‰ˆæœ¬ v${{ needs.version.outputs.new_version }}
          body: ${{ fromJSON(needs.version.outputs.release_notes) }}
          draft: false
          prerelease: ${{ inputs.pre_release }}
          files: macos/**/*,windows/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: å‘å¸ƒæ‘˜è¦
        run: |
          echo "### âœ… å‘å¸ƒæˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç‰ˆæœ¬:** v${{ needs.version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**ç±»å‹:** ${{ inputs.version_type }}" >> $GITHUB_STEP_SUMMARY
          echo "**é¢„å‘å¸ƒ:** ${{ inputs.pre_release }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### ğŸ“¦ æ„å»ºäº§ç‰©" >> $GITHUB_STEP_SUMMARY
          echo "- macOS: DMG + ZIP" >> $GITHUB_STEP_SUMMARY
          echo "- Windows: ZIP + Squirrel å®‰è£…åŒ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“¥ [ä¸‹è½½å‘å¸ƒåŒ…](https://github.com/${{ github.repository }}/releases/tag/v${{ needs.version.outputs.new_version }})" >> $GITHUB_STEP_SUMMARY
