name: ç®¡ç†æˆæƒ

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'æ“ä½œç±»å‹'
        required: true
        type: choice
        options:
          - add
          - remove
          - enable
          - disable
          - list
      machine_id:
        description: 'æœºå™¨ IDï¼ˆæ·»åŠ /ç§»é™¤/å¯ç”¨/ç¦ç”¨æ—¶å¿…å¡«ï¼‰'
        required: false
        type: string
      user_name:
        description: 'ç”¨æˆ·åï¼ˆä»…æ·»åŠ æ—¶éœ€è¦ï¼‰'
        required: false
        type: string

permissions:
  contents: write

jobs:
  manage-license:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: éªŒè¯è¾“å…¥å‚æ•°
        run: |
          ACTION="${{ inputs.action }}"
          MACHINE_ID="${{ inputs.machine_id }}"
          USER_NAME="${{ inputs.user_name }}"

          echo "æ“ä½œç±»å‹: $ACTION"

          if [ "$ACTION" != "list" ] && [ -z "$MACHINE_ID" ]; then
            echo "âŒ é”™è¯¯: æ“ä½œç±»å‹ä¸º '$ACTION' æ—¶å¿…é¡»æä¾›æœºå™¨ ID"
            exit 1
          fi

          if [ "$ACTION" = "add" ] && [ -z "$USER_NAME" ]; then
            echo "âŒ é”™è¯¯: æ·»åŠ æˆæƒæ—¶å¿…é¡»æä¾›ç”¨æˆ·å"
            exit 1
          fi

          echo "âœ… å‚æ•°éªŒè¯é€šè¿‡"

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: å¤„ç†æˆæƒ
        run: |
          ACTION="${{ inputs.action }}"
          MACHINE_ID="${{ inputs.machine_id }}"
          USER_NAME="${{ inputs.user_name }}"
          LICENSE_FILE="licenses.json"

          # ç¡®ä¿ licenses.json å­˜åœ¨
          if [ ! -f "$LICENSE_FILE" ]; then
            echo "åˆå§‹åŒ–æˆæƒæ–‡ä»¶..."
            cat > "$LICENSE_FILE" << 'EOF'
          {
            "version": "1.0",
            "updatedAt": "2026-02-07T00:00:00Z",
            "specialKeys": [
              {
                "key": "VS-MASTER-2024-KEY01",
                "name": "ç®¡ç†å‘˜å¯†é’¥ #1",
                "enabled": true,
                "description": "ä¸‡èƒ½æˆæƒå¯†é’¥ï¼Œå¯ç”¨åæ‰€æœ‰å®‰è£…æ­¤è½¯ä»¶çš„è®¾å¤‡éƒ½å¯ä»¥ä½¿ç”¨"
              },
              {
                "key": "VS-MASTER-2024-KEY02",
                "name": "ç®¡ç†å‘˜å¯†é’¥ #2",
                "enabled": true,
                "description": "å¤‡ç”¨ä¸‡èƒ½æˆæƒå¯†é’¥"
              },
              {
                "key": "VS-MASTER-2024-KEY03",
                "name": "ç®¡ç†å‘˜å¯†é’¥ #3",
                "enabled": true,
                "description": "å¤‡ç”¨ä¸‡èƒ½æˆæƒå¯†é’¥"
              }
            ],
            "licenses": []
          }
          EOF
          fi

          # è¯»å–å½“å‰æˆæƒæ•°æ®
          LICENSES=$(cat "$LICENSE_FILE")

          # æ ¹æ® action æ‰§è¡Œä¸åŒæ“ä½œ
          case "$ACTION" in
            add)
              echo "ğŸ“ æ·»åŠ æˆæƒ: $USER_NAME ($MACHINE_ID)"

              # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
              if echo "$LICENSES" | jq -e ".licenses[] | select(.machineId == \"$MACHINE_ID\")" > /dev/null; then
                echo "æ›´æ–°ç°æœ‰æˆæƒ..."
                LICENSES=$(echo "$LICENSES" | jq \
                  --arg machine_id "$MACHINE_ID" \
                  --arg user_name "$USER_NAME" \
                  '(.licenses[] | select(.machineId == $machine_id)) |= {
                    machineId: $machine_id,
                    user: $user_name,
                    enabled: true,
                    updatedAt: now | todate
                  } | .updatedAt = (now | todate)')
              else
                echo "æ·»åŠ æ–°æˆæƒ..."
                LICENSES=$(echo "$LICENSES" | jq \
                  --arg machine_id "$MACHINE_ID" \
                  --arg user_name "$USER_NAME" \
                  '.licenses += [{
                    machineId: $machine_id,
                    user: $user_name,
                    enabled: true,
                    createdAt: (now | todate)
                  }] | .updatedAt = (now | todate)')
              fi
              ;;

            remove)
              echo "ğŸ—‘ï¸  ç§»é™¤æˆæƒ: $MACHINE_ID"

              if echo "$LICENSES" | jq -e ".licenses[] | select(.machineId == \"$MACHINE_ID\")" > /dev/null; then
                REMOVED_USER=$(echo "$LICENSES" | jq -r ".licenses[] | select(.machineId == \"$MACHINE_ID\") | .user")
                echo "ç§»é™¤ç”¨æˆ·: $REMOVED_USER"
                LICENSES=$(echo "$LICENSES" | jq \
                  --arg machine_id "$MACHINE_ID" \
                  'del(.licenses[] | select(.machineId == $machine_id)) | .updatedAt = (now | todate)')
              else
                echo "âŒ æœªæ‰¾åˆ°æœºå™¨ ID: $MACHINE_ID"
                exit 1
              fi
              ;;

            enable)
              echo "âœ… å¯ç”¨æˆæƒ: $MACHINE_ID"

              if echo "$LICENSES" | jq -e ".licenses[] | select(.machineId == \"$MACHINE_ID\")" > /dev/null; then
                USER_NAME=$(echo "$LICENSES" | jq -r ".licenses[] | select(.machineId == \"$MACHINE_ID\") | .user")
                CURRENT_STATUS=$(echo "$LICENSES" | jq -r ".licenses[] | select(.machineId == \"$MACHINE_ID\") | .enabled")

                if [ "$CURRENT_STATUS" = "true" ]; then
                  echo "â„¹ï¸  æˆæƒå·²æ˜¯å¯ç”¨çŠ¶æ€: $USER_NAME"
                else
                  echo "å¯ç”¨ç”¨æˆ·æˆæƒ: $USER_NAME"
                  LICENSES=$(echo "$LICENSES" | jq \
                    --arg machine_id "$MACHINE_ID" \
                    '(.licenses[] | select(.machineId == $machine_id)).enabled = true | .updatedAt = (now | todate)')
                fi
              else
                echo "âŒ æœªæ‰¾åˆ°æœºå™¨ ID: $MACHINE_ID"
                exit 1
              fi
              ;;

            disable)
              echo "âŒ ç¦ç”¨æˆæƒ: $MACHINE_ID"

              if echo "$LICENSES" | jq -e ".licenses[] | select(.machineId == \"$MACHINE_ID\")" > /dev/null; then
                USER_NAME=$(echo "$LICENSES" | jq -r ".licenses[] | select(.machineId == \"$MACHINE_ID\") | .user")
                CURRENT_STATUS=$(echo "$LICENSES" | jq -r ".licenses[] | select(.machineId == \"$MACHINE_ID\") | .enabled")

                if [ "$CURRENT_STATUS" = "false" ]; then
                  echo "â„¹ï¸  æˆæƒå·²æ˜¯ç¦ç”¨çŠ¶æ€: $USER_NAME"
                else
                  echo "ç¦ç”¨ç”¨æˆ·æˆæƒ: $USER_NAME"
                  LICENSES=$(echo "$LICENSES" | jq \
                    --arg machine_id "$MACHINE_ID" \
                    '(.licenses[] | select(.machineId == $machine_id)).enabled = false | .updatedAt = (now | todate)')
                fi
              else
                echo "âŒ æœªæ‰¾åˆ°æœºå™¨ ID: $MACHINE_ID"
                exit 1
              fi
              ;;

            list)
              echo "ğŸ“‹ æˆæƒåˆ—è¡¨:"
              echo ""
              echo "ç‰ˆæœ¬: $(echo "$LICENSES" | jq -r '.version')"
              echo "æ›´æ–°æ—¶é—´: $(echo "$LICENSES" | jq -r '.updatedAt')"
              echo "æ€»æ•°: $(echo "$LICENSES" | jq -r '.licenses | length')"
              echo ""
              echo "$LICENSES" | jq -r '.licenses[] | "çŠ¶æ€: \(.enabled), ç”¨æˆ·: \(.user // "æœªçŸ¥"), æœºå™¨ID: \(.machineId)"' | while IFS= read -r line; do
                if echo "$line" | grep -q "çŠ¶æ€: true"; then
                  echo "âœ… $line"
                else
                  echo "âŒ $line"
                fi
              done
              ;;
          esac

          # ä¿å­˜æ›´æ–°åçš„æˆæƒæ–‡ä»¶ï¼ˆé list æ“ä½œï¼‰
          if [ "$ACTION" != "list" ]; then
            echo "$LICENSES" | jq '.' > "$LICENSE_FILE"
            echo "âœ… æˆæƒæ–‡ä»¶å·²æ›´æ–°"
          fi

      - name: æ˜¾ç¤ºæˆæƒåˆ—è¡¨
        if: inputs.action != 'list'
        run: |
          echo "ğŸ“‹ æ›´æ–°åçš„æˆæƒåˆ—è¡¨:"
          echo ""
          echo "ç‰ˆæœ¬: $(cat licenses.json | jq -r '.version')"
          echo "æ›´æ–°æ—¶é—´: $(cat licenses.json | jq -r '.updatedAt')"
          echo "æ€»æ•°: $(cat licenses.json | jq -r '.licenses | length')"
          echo ""
          cat licenses.json | jq -r '.licenses[] | "çŠ¶æ€: \(.enabled), ç”¨æˆ·: \(.user // "æœªçŸ¥"), æœºå™¨ID: \(.machineId)"' | while IFS= read -r line; do
            if echo "$line" | grep -q "çŠ¶æ€: true"; then
              echo "âœ… $line"
            else
              echo "âŒ $line"
            fi
          done

      - name: æäº¤æ›´æ”¹
        if: inputs.action != 'list'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          ACTION="${{ inputs.action }}"
          MACHINE_ID="${{ inputs.machine_id }}"
          USER_NAME="${{ inputs.user_name }}"

          case "$ACTION" in
            add)
              COMMIT_MSG="feat: æ·»åŠ æˆæƒ - $USER_NAME ($MACHINE_ID)"
              ;;
            remove)
              COMMIT_MSG="feat: ç§»é™¤æˆæƒ - $MACHINE_ID"
              ;;
            enable)
              COMMIT_MSG="feat: å¯ç”¨æˆæƒ - $MACHINE_ID"
              ;;
            disable)
              COMMIT_MSG="feat: ç¦ç”¨æˆæƒ - $MACHINE_ID"
              ;;
          esac

          git add licenses.json
          git diff --staged --quiet || git commit -m "$COMMIT_MSG"
          git push

      - name: åˆ›å»º/æ›´æ–° Release
        if: inputs.action != 'list'
        run: |
          # å®‰è£… GitHub CLI
          # ä½¿ç”¨é¢„è£…çš„ gh å‘½ä»¤

          RELEASE_TAG="licenses"
          REPO_OWNER="${{ github.repository_owner }}"
          REPO_NAME="${{ github.event.repository.name }}"

          echo "å‡†å¤‡æ›´æ–° Release: $RELEASE_TAG"

          # æ£€æŸ¥ Release æ˜¯å¦å­˜åœ¨
          if gh release view "$RELEASE_TAG" --repo "$REPO_OWNER/$REPO_NAME" > /dev/null 2>&1; then
            echo "æ›´æ–°ç°æœ‰ Release..."
            gh release upload "$RELEASE_TAG" licenses.json --clobber --repo "$REPO_OWNER/$REPO_NAME"
          else
            echo "åˆ›å»ºæ–° Release..."
            gh release create "$RELEASE_TAG" licenses.json \
              --title "æˆæƒæ–‡ä»¶" \
              --notes "VideoStitcher æˆæƒæ–‡ä»¶ï¼ŒåŒ…å«æ‰€æœ‰å·²æˆæƒçš„æœºå™¨ ID åˆ—è¡¨ã€‚" \
              --repo "$REPO_OWNER/$REPO_NAME"
          fi

          echo "âœ… Release å·²æ›´æ–°"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
